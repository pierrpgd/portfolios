{% extends 'base.html' %}

{% block extra_css %}
    <style>
        .hoverable-row:hover {
            background-color: #0869c9 !important;
            color: white !important;
        }
        .table {
            cursor: default;
        }
        .table * {
            cursor: default;
        }
        .table tr:hover {
            cursor: default;
        }
        .hoverable-row:hover {
            cursor: default;
        }
        
        /* Style pour la popup About */
        #aboutModal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            width: 80%;
            max-width: none;
            font-size: 1.2em;
            line-height: 1.6;
        }
        #aboutModalContent {
            margin-bottom: 20px;
            padding: 20px;
            border-radius: 5px;
            background: #f8f9fa;
        }
        #aboutModal button.close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6c757d;
            transition: color 0.2s;
        }
        #aboutModal button.close:hover {
            color: #343a40;
        }
        
        /* Fond gris transparent */
        #aboutModalBackdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
        
        /* Style pour les modals Experience et Projects */
        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            width: 80%;
            max-width: none;
            font-size: 1.2em;
            line-height: 1.6;
            margin: 0;
            height: fit-content;
        }
        .modal-content {
            padding: 20px;
            border-radius: 5px;
            background: #f8f9fa;
            min-height: 60px;
            margin: 0;
            border: 1px solid #e0e0e0;
        }
        .modal-content-title {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
            padding-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
        }
        .modal-content-text {
            font-size: 1.1em;
            line-height: 1.6;
            color: #666;
            padding: 15px;
            background: white;
            border-radius: 3px;
            border: 1px solid #e0e0e0;
        }
        .modal-content-info {
            color: #666;
        }
        .modal-content-info span {
            color: #333;
        }
        .modal-content-info-title {
            font-weight: bold;
        }
        .modal button.close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6c757d;
            transition: color 0.2s;
            margin: 0;
        }
        .modal button.close:hover {
            color: #343a40;
        }
        .modal-header {
            min-height: 50px;
            border-bottom: 1px solid #ddd;
        }
        
        /* Style pour les modals Experience et Projects */
        .modal-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        .editable-field {
            margin-bottom: 20px;
        }

        .editable-content {
            cursor: text;
            padding: 10px;
            border: 2px solid #e0e0e0;  /* Bordure grise claire */
            transition: border-color 0.2s;
            border-radius: 4px;  /* Coins légèrement arrondis */
            background-color: #fff;
        }

        .editable-content:focus {
            outline: none;
            border-color: #80bdff;  /* Bleu plus foncé au focus */
            background-color: #fff;
        }
    </style>
{% endblock %}

{% block extra_js %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Variable pour suivre le profil actuellement sélectionné
            let selectedProfile = null;

            // Sélection/désélection d'une ligne au clic
            document.querySelectorAll('.table tbody tr').forEach(row => {
                row.addEventListener('click', function() {
                    const profileIdentifiant = this.querySelector('td:first-child').textContent;
                    
                    // Si c'est le même profil qui est cliqué, on désélectionne
                    if (selectedProfile === profileIdentifiant) {
                        // Désélectionner la ligne
                        this.classList.remove('table-active');
                        // Effacer les données affichées
                        document.querySelector('#profile-data').innerHTML = '';
                        selectedProfile = null;
                        return;
                    }

                    // Désélectionner toutes les lignes
                    document.querySelectorAll('.table tbody tr').forEach(row => {
                        row.classList.remove('table-active');
                    });
                    // Sélectionner la ligne cliquée
                    this.classList.add('table-active');
                    
                    // Mettre à jour le profil sélectionné
                    selectedProfile = profileIdentifiant;
                    
                    // Charger les données du profil sélectionné
                    fetch(`/load_profile_data/?identifiant=${profileIdentifiant}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.error) {
                                document.querySelector('#profile-data').innerHTML = `
                                    <div class="alert alert-danger">${data.error}</div>
                                `;
                                return;
                            }

                            // Créer le HTML pour les données
                            const html = `
                                <div class="card mb-4">
                                    <div class="card-header">
                                        <h2>À propos</h2>
                                    </div>
                                    <div class="card-body">
                                        ${data.about.length > 0 ? `
                                            <table id="about-table" class="table table-hover">
                                                <thead>
                                                    <tr>
                                                        <th>Ordre</th>
                                                        <th>Contenu</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${data.about.map(about => `
                                                        <tr class="about-row" data-content="${about.content}">
                                                            <td>${about.order}</td>
                                                            <td>${about.content}</td>
                                                        </tr>
                                                    `).join('')}
                                                </tbody>
                                            </table>
                                        ` : `
                                            <p>Aucune section About trouvée</p>
                                        `}
                                    </div>
                                </div>

                                <div class="card mb-4">
                                    <div class="card-header">
                                        <h2>Expériences</h2>
                                    </div>
                                    <div class="card-body">
                                        ${data.experience.length > 0 ? `
                                            <table id="experience-table" class="table table-hover">
                                                <thead>
                                                    <tr>
                                                        <th>Ordre</th>
                                                        <th>Période</th>
                                                        <th>Poste</th>
                                                        <th>Entreprise</th>
                                                        <th>Localisation</th>
                                                        <th>Description</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${data.experience.map(exp => `
                                                        <tr class="experience-row" data-content="${exp.description}" data-dates="${exp.dates}" data-company="${exp.company}" data-location="${exp.location}">
                                                            <td>${exp.order}</td>
                                                            <td>${exp.dates}</td>
                                                            <td>${exp.position}</td>
                                                            <td>${exp.company}</td>
                                                            <td>${exp.location}</td>
                                                            <td>${exp.description}</td>
                                                        </tr>
                                                    `).join('')}
                                                </tbody>
                                            </table>
                                        ` : `
                                            <p>Aucune expérience trouvée</p>
                                        `}
                                    </div>
                                </div>

                                <div class="card mb-4">
                                    <div class="card-header">
                                        <h2>Projets</h2>
                                    </div>
                                    <div class="card-body">
                                        ${data.projects.length > 0 ? `
                                            <table id="projects-table" class="table table-hover">
                                                <thead>
                                                    <tr>
                                                        <th>Ordre</th>
                                                        <th>Titre</th>
                                                        <th>Description</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${data.projects.map(project => `
                                                        <tr class="project-row" data-title="${project.title}" data-content="${project.description}">
                                                            <td>${project.order}</td>
                                                            <td>${project.title}</td>
                                                            <td>${project.description}</td>
                                                        </tr>
                                                    `).join('')}
                                                </tbody>
                                            </table>
                                        ` : `
                                            <p>Aucun projet trouvé</p>
                                        `}
                                    </div>
                                </div>
                            `;

                            // Mettre à jour le DOM
                            document.querySelector('#profile-data').innerHTML = html;

                            // Ajouter les gestionnaires d'événements pour les lignes About
                            document.querySelectorAll('.about-row').forEach(row => {
                                row.addEventListener('dblclick', function() {
                                    showPopup(row, 'aboutModal', 'aboutModalContent');
                                });
                            });

                            // Ajouter les gestionnaires d'événements pour les lignes Experience
                            document.querySelectorAll('.experience-row').forEach(row => {
                                row.addEventListener('dblclick', function() {
                                    showPopup(row, 'experienceModal', 'experienceModalContent');
                                });
                            });

                            // Ajouter les gestionnaires d'événements pour les lignes Projects
                            document.querySelectorAll('.project-row').forEach(row => {
                                row.addEventListener('dblclick', function() {
                                    showPopup(row, 'projectModal', 'projectModalContent');
                                });
                            });
                        })
                        .catch(error => {
                            console.error('Erreur:', error);
                            document.querySelector('#profile-data').innerHTML = `
                                <div class="alert alert-danger">Erreur lors du chargement des données</div>
                            `;
                        });
                });
            });
        });

        // Fonction pour afficher une popup générique
        function showPopup(row, modalId, contentId) {
            const content = row.getAttribute('data-content');
            const dates = row.getAttribute('data-dates');
            const company = row.getAttribute('data-company');
            const location = row.getAttribute('data-location');
            const projectTitle = row.getAttribute('data-title');
            const title = modalId === 'aboutModal' ? 'À propos' : 
                         modalId === 'experienceModal' ? 'Expérience' : 
                         'Projet';
            
            // Créer la popup si elle n'existe pas déjà
            let modal = document.getElementById(modalId);
            let backdrop = document.getElementById('modalBackdrop');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = modalId;
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-header">
                        <button class="close">&times;</button>
                    </div>
                    <div class="modal-content">
                        <div class="modal-content-title">${title}</div>
                        ${modalId === 'experienceModal' ? `
                            <div class="modal-content-info">
                                <div class="editable-field">
                                    <span class="modal-content-info-title">Période :</span> <span contenteditable="true" class="editable-content" data-field="dates">${dates}</span>
                                </div>
                                <div class="editable-field">
                                    <span class="modal-content-info-title">Entreprise :</span> <span contenteditable="true" class="editable-content" data-field="company">${company}</span>
                                </div>
                                <div class="editable-field">
                                    <span class="modal-content-info-title">Localisation :</span> <span contenteditable="true" class="editable-content" data-field="location">${location}</span>
                                </div>
                            </div>
                            <span class="modal-content-info-title">Description :</span>
                        ` : modalId === 'projectModal' ? `
                            <div class="modal-content-info">
                                <div class="editable-field">
                                    <span class="modal-content-info-title">Titre :</span> <span contenteditable="true" class="editable-content" data-field="title">${projectTitle}</span>
                                </div>
                            </div>
                            <span class="modal-content-info-title">Description :</span>
                        ` : `<span class="modal-content-info-title">Contenu :</span>`}
                        <div contenteditable="true" class="editable-content" data-field="content">${content}</div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            if (!backdrop) {
                backdrop = document.createElement('div');
                backdrop.id = 'modalBackdrop';
                backdrop.className = 'modal-backdrop';
                document.body.appendChild(backdrop);
            }
            
            // Afficher la popup et le fond
            modal.style.display = 'block';
            backdrop.style.display = 'block';
            
            // Ajouter l'événement de fermeture
            document.querySelector(`#${modalId} button.close`).onclick = function() {
                modal.style.display = 'none';
                backdrop.style.display = 'none';
            };
            
            // Fermer la popup en cliquant en dehors
            window.onclick = function(event) {
                if (event.target == backdrop || event.target == modal) {
                    modal.style.display = 'none';
                    backdrop.style.display = 'none';
                }
            };
        }

        function editContent(event) {
            const modal = event.target.closest('.modal');
            const infoFields = modal.querySelectorAll('.modal-content-info .editable-content');
            const textFields = modal.querySelectorAll('.modal-content-text .editable-content');
            
            // Cacher les boutons d'édition et montrer les boutons de sauvegarde
            modal.querySelector('.edit-button').style.display = 'none';
            modal.querySelector('.save-button').style.display = 'inline';
            modal.querySelector('.cancel-button').style.display = 'inline';
            
            // Transformer les éléments en inputs
            infoFields.forEach(field => {
                const originalContent = field.textContent;
                field.innerHTML = `
                    <input type="text" value="${originalContent}" 
                        class="form-control" 
                        data-original="${originalContent}">
                `;
            });
            
            textFields.forEach(field => {
                const originalContent = field.textContent;
                field.innerHTML = `
                    <textarea class="form-control" 
                            rows="4"
                            data-original="${originalContent}">${originalContent}</textarea>
                `;
            });
        }

        function saveContent(event) {
            const modal = event.target.closest('.modal');
            const infoFields = modal.querySelectorAll('.modal-content-info .editable-content');
            const textFields = modal.querySelectorAll('.modal-content-text .editable-content');
            
            // Récupérer les nouvelles valeurs
            const data = {
                dates: infoFields[0].querySelector('input').value,
                company: infoFields[1].querySelector('input').value,
                location: infoFields[2].querySelector('input').value,
                content: textFields[0].querySelector('textarea').value
            };
            
            // Sauvegarder les modifications via AJAX
            fetch('/save_content/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    // Mettre à jour l'interface
                    infoFields.forEach(field => {
                        const input = field.querySelector('input');
                        field.textContent = input.value;
                    });
                    textFields.forEach(field => {
                        const textarea = field.querySelector('textarea');
                        field.textContent = textarea.value;
                    });
                    
                    // Réinitialiser les boutons
                    modal.querySelector('.edit-button').style.display = 'inline';
                    modal.querySelector('.save-button').style.display = 'none';
                    modal.querySelector('.cancel-button').style.display = 'none';
                } else {
                    alert('Erreur lors de la sauvegarde');
                }
            });
        }

        function cancelEdit(event) {
            const modal = event.target.closest('.modal');
            const infoFields = modal.querySelectorAll('.modal-content-info .editable-content');
            const textFields = modal.querySelectorAll('.modal-content-text .editable-content');
            
            // Restaurer les valeurs originales
            infoFields.forEach(field => {
                const originalContent = field.querySelector('input').dataset.original;
                field.textContent = originalContent;
            });
            
            textFields.forEach(field => {
                const originalContent = field.querySelector('textarea').dataset.original;
                field.textContent = originalContent;
            });
            
            // Réinitialiser les boutons
            modal.querySelector('.edit-button').style.display = 'inline';
            modal.querySelector('.save-button').style.display = 'none';
            modal.querySelector('.cancel-button').style.display = 'none';
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Fonction pour supprimer une modal
            const removeModal = function(modal) {
                const backdrop = document.getElementById('modalBackdrop');
                if (backdrop) {
                    backdrop.remove();
                }
                modal.remove();
            };

            // Ajouter un gestionnaire d'événements pour les boutons de fermeture
            document.body.addEventListener('click', function(e) {
                if (e.target && e.target.classList.contains('close')) {
                    const modal = e.target.closest('.modal');
                    if (modal) {
                        removeModal(modal);
                    }
                }
            });

            // Ajouter un gestionnaire d'événements pour le clic en dehors de la modal
            document.body.addEventListener('click', function(e) {
                const backdrop = document.getElementById('modalBackdrop');
                const modal = document.querySelector('.modal');
                if (backdrop && e.target === backdrop) {
                    // Seulement si le clic est sur le backdrop (pas sur la modal)
                    removeModal(modal);
                }
            });

            // Empêcher la fermeture lors du clic à l'intérieur de la modal
            document.body.addEventListener('click', function(e) {
                const modal = document.querySelector('.modal');
                if (modal && modal.contains(e.target)) {
                    e.stopPropagation();
                }
            });
        });
    </script>
{% endblock %}

{% block content %}
    <div class="container" style="background-color: white;">
        <h1>Données de la Base de Données</h1>

        <div class="card mb-4">
            <div class="card-header d-flex align-items-center">
                <h2>Profils</h2>
                <div class="ms-auto">
                    <a href="{% url 'add_profile' %}" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Ajouter un profil
                    </a>
                </div>
            </div>
            <div class="card-body">
                {% if profiles %}
                    <table id="profile-table" class="table table-hover">
                        <thead>
                            <tr>
                                <th>Identifiant</th>
                                <th>Nom</th>
                                <th>Créé le</th>
                                <th>Mis à jour le</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for profile in profiles %}
                                <tr>
                                    <td>{{ profile.identifiant }}</td>
                                    <td>{{ profile.name }}</td>
                                    <td>{{ profile.created_at|date:"F j, Y, g:i a" }}</td>
                                    <td>{{ profile.updated_at|date:"F j, Y, g:i a" }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p class="text-muted">Aucun profil trouvé</p>
                {% endif %}
            </div>
        </div>

        <!-- Conteneur pour les données du profil sélectionné -->
        <div id="profile-data">
            <!-- Les données seront chargées ici via AJAX -->
            <div class="text-muted text-center py-5">
                Sélectionnez un profil pour voir ses données
            </div>
        </div>
    </div>
{% endblock %}
